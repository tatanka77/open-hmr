<?xml version='1.0' ?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/">
<bookmark> GTALK </bookmark>

<onEnter>
	setRefreshTime(400000);
	bg_flag=0;
	
        status = gtalk_getMyStatus();
        if (status != "SIGNEDIN") {
			print("gtalk not singedin~");
             	postMessage("guide");
        }


	
	path = getStoragePath("tmp") + "gtalk_showoffline.dat";
	ifshow= readStringFromFile(path);
	if(ifshow==null)
		showOffline="1";
	else if(ifshow=="yes")
		showOffline="1";
	else
		showOffline="0";
	
	print("-=-=-=-= Enter gtalk -=-=-=-=");


	  xmlFile = gtalk_getUsers();
	  print("get user xml:",xmlFile);


	if (xmlFile != null)
	{
		parseResult = gtalk_parseXMLFile(xmlFile);
		if (parseResult != null)
		{
				msgjidCount=getXMLElementCount("report","message","jid");

		self_status=getXMLText("report","self","status");
		self_display=getXMLText("report","self","display");
		self_id=getXMLText("report","self","id");

		self_show=getXMLText("report","self","show");
		self_statusString=getXMLText("report","self","statusString");

	 print("showOffline===",showOffline);

		if(showOffline=="1")
			{
	 				rosterCount=getXMLElementCount("report","roster","item");
					subCount=getXMLElementCount("report","subscription","jid");
					friendCount=Add(rosterCount,subCount);

					tmp_repeatArray=null;
					tmp_repeatArrayCount=0;
					tmp_repeatNum=0;
					onlineFriendCount=getXMLElementCount("report","friend");
					index = 0;
					while(1)
						{
							if(index==onlineFriendCount)
								break;

							tmpDisplay=getXMLText("report","friend",index,"display");

							tmp_repeatIndex=0;
							while(1)
								{
									if(tmp_repeatIndex==tmp_repeatArrayCount)
										{
										tmp_repeatArray=pushBackStringArray(tmp_repeatArray, tmpDisplay);
										tmp_repeatArrayCount=Add(tmp_repeatArrayCount,1);
										break;	
										}

									tmp_repeatDisplay=getStringArrayAt(tmp_repeatArray,tmp_repeatIndex);
									if(tmpDisplay==tmp_repeatDisplay)
										{
										tmp_repeatNum=Add(tmp_repeatNum,1);
										break;
										}
									tmp_repeatIndex=Add(tmp_repeatIndex,1);

								}
							index=Add(index,1);

						}
					print("=============tmp_repeatNum=",tmp_repeatNum);
					friendCount=Add(friendCount,tmp_repeatNum);
					
					print("show offline friends--friendCount :: ",friendCount);
						if (friendCount &gt; 0)
						{
							
							
							statusArray=null;
							fileshareArray=null;
							displayArray=null;
							idArray=null;	
							imageArray = null;
							statusStringArray=null;
							fileSharingArray=null;

							newmsgArray=null;

							subCount=getXMLElementCount("report","subscription","jid");
							index = 0;
							while (1)
							{
								if (index == subCount)
									break;

								display=getXMLText("report","subscription","jid",index);

								status="invite you";

								image = "../image/offline.png";
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray,"no");
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, display);					
								imageArray = pushBackStringArray(imageArray, image);
								statusStringArray=pushBackStringArray(statusStringArray," ");
								fileSharingArray=pushBackStringArray(fileSharingArray,"no");

								newmsgArray = pushBackStringArray(newmsgArray, "no");
								
			                               print("get invite friend status:",status,fileshare,display);

								index = index + 1;
							}
						
							
							onlineFriendCount=getXMLElementCount("report","friend");
							index = 0;
							while (1)
							{
								if (index == onlineFriendCount)
									break;

								status=getXMLText("report","friend",index,"status");
								if(status=="5") status="Available";
								if(status=="4") status="busy";
								if(status=="3") status="idle";
								
								fileshare=getXMLText("report","friend",index,"fileshare");
								display=getXMLText("report","friend",index,"display");
								id=getXMLText("report","friend",index,"id");
								image = "../image/gtalker_default.jpg";
								statusString=getXMLText("report","friend",index,"statusString");
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray, fileshare);
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, id);					
								imageArray = pushBackStringArray(imageArray, image);

								fileCount=getXMLElementCount("report","file");
								if(fileCount &gt; 0)
									{
									   fileIndex=0;
									   while(1)
									   	{
									   	  if(fileIndex ==fileCount)
									   	  	{
									   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
											break;
										  	}

										  fileid=getXMLText("report","file",fileIndex,"id");

										  if(fileid==id)
										  	{
										  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
											break;
										  	}
										  fileIndex=Add(fileIndex,1);


									   	}


									}else
										{
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										}
								
									
								statusStringArray=pushBackStringArray(statusStringArray,statusString);

								
								msgjidCount=getXMLElementCount("report","message","jid");
								if(msgjidCount &gt; 0)
									{
										msgjidIndex=0;
										while(1)
										{
										    if(msgjidIndex==msgjidCount)
										    	{
			 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
												break;
										    	}

										    msgjid=getXMLText("report","message","jid",msgjidIndex);

										     if(display==gtalk_getMsgJidName(msgjid))
										     	{
												newmsgArray = pushBackStringArray(newmsgArray, "yes");	
												
												break;
											 }

			   							    msgjidIndex=msgjidIndex+1;
										}

										
									}
								else
									newmsgArray = pushBackStringArray(newmsgArray, "no");

								parseResult = gtalk_parseXMLFile(xmlFile);
								
			                               print("get 111friend status:",status,fileshare,display,id);

								index = index + 1;
							}

							offlineFriendCount=Minus(friendCount,onlineFriendCount);
							offlineFriendCount=Minus(offlineFriendCount,subCount);
							offlineFriendCount=Add(offlineFriendCount,tmp_repeatNum);

							index = 0;
							while(1)
							{
								if (index == friendCount)
									break;	

								jid=getXMLText("report","roster","item",index,"jid");
								subscription=getXMLText("report","roster","item",index,"subscription");
								print("jid===========",jid);
								onlineIndex=0;
								while(1)
									{
										if (onlineIndex == onlineFriendCount)
											break;

										status=getXMLText("report","friend",onlineIndex,"status");
										if(status=="5") status="Available";
										if(status=="4") status="busy";
										if(status=="3") status="idle";
										
										fileshare=getXMLText("report","friend",onlineIndex,"fileshare");
										display=getXMLText("report","friend",onlineIndex,"display");
										id=getXMLText("report","friend",onlineIndex,"id");
										image = "../image/gtalker_default.jpg";

										if(jid==display)
											{
											print("jid==display=============",display);
												break;
											}
										

										
					                               print("get 222friend status:",status,fileshare,display,id);

										onlineIndex = onlineIndex + 1;


									}

								if(onlineIndex == onlineFriendCount)
									{
										if(subscription=="none")
											statusArray=pushBackStringArray(statusArray, "Invited");
										else
											statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, jid);
										idArray=pushBackStringArray(idArray, jid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");


										msgjidCount=getXMLElementCount("report","message","jid");
										if(msgjidCount &gt; 0)
											{
												msgjidIndex=0;
												while(1)
												{
												    if(msgjidIndex==msgjidCount)
												    	{
					 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
														break;
												    	}

												    msgjid=getXMLText("report","message","jid",msgjidIndex);

												     if(jid==gtalk_getMsgJidName(msgjid))
												     	
													{
														newmsgArray = pushBackStringArray(newmsgArray, "yes");

														break;
													 
													}


					   							    msgjidIndex=msgjidIndex+1;
												
												}


												
																						}else
	
												newmsgArray = pushBackStringArray(newmsgArray, "no");

										parseResult = gtalk_parseXMLFile(xmlFile);
											}

									
								index=index+1;
								
							}
							
						}

			}
			else
			{
			onlinefriendCount=getXMLElementCount("report","friend");
			subCount=getXMLElementCount("report","subscription","jid");

			msgjidCount=getXMLElementCount("report","message","jid");
			offlineMsgCount=0;
			
			if(msgjidCount &gt; 0)
				{
				msgjidIndex=0;
				while(1)
					{
						 if(msgjidIndex==msgjidCount)
							break;
						msgjid=getXMLText("report","message","jid",msgjidIndex);

						index=0;
						while(1)
							{
							 if(index==onlinefriendCount)
							 	{
							 	offlineMsgCount=Add(offlineMsgCount,1);
								break;
							 	}

							 display=getXMLText("report","friend",index,"display");
							 if(display==gtalk_getMsgJidName(msgjid))
							 	break;			
							 index=Add(index,1);
							}
						


						msgjidIndex=Add(msgjidIndex,1);


					}

				}
			
			
			friendCount=Add(onlinefriendCount,subCount);
			friendCount=Add(friendCount,offlineMsgCount);
			
			print("friendCount :: ",friendCount);
			if (friendCount &gt; 0)
			{

				
				statusArray=null;
				fileshareArray=null;
				displayArray=null;
				idArray=null;	
				imageArray = null;
				statusString=null;
				fileSharingArray=null;
				
				newmsgArray=null;

				subCount=getXMLElementCount("report","subscription","jid");
				index = 0;
				while (1)
				{
					if (index == subCount)
						break;

					display=getXMLText("report","subscription","jid",index);

					status="invite you";

					image = "../image/offline.png";
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray,"no");
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, display);					
					imageArray = pushBackStringArray(imageArray, image);
					statusStringArray=pushBackStringArray(statusStringArray," ");
					fileSharingArray=pushBackStringArray(fileSharingArray,"no");
					
					newmsgArray = pushBackStringArray(newmsgArray, "no");
					
                               print("get invite friend status:",status,fileshare,display);

					index = index + 1;
				}
			

				onlinefriendCount=getXMLElementCount("report","friend");
				index = 0;
				while (1)
				{
					if (index == onlinefriendCount)
						break;



					status=getXMLText("report","friend",index,"status");
					if(status=="5") status="Available";
					if(status=="4") status="busy";
					if(status=="3") status="idle";
					
					fileshare=getXMLText("report","friend",index,"fileshare");
					display=getXMLText("report","friend",index,"display");
					id=getXMLText("report","friend",index,"id");
					image = "../image/gtalker_default.jpg";
					statusString=getXMLText("report","friend",index,"statusString");
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray, fileshare);
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, id);					
					imageArray = pushBackStringArray(imageArray, image);
					
					fileCount=getXMLElementCount("report","file");
					if(fileCount &gt; 0)
						{
						   fileIndex=0;
						   while(1)
						   	{
						   	  if(fileIndex ==fileCount)
						   	  	{
						   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
								break;
							  	}

							  fileid=getXMLText("report","file",fileIndex,"id");

							  if(fileid==id)
							  	{
							  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
								break;
							  	}
							  fileIndex=Add(fileIndex,1);


						   	}


						}else
							{
							fileSharingArray=pushBackStringArray(fileSharingArray,"no");
							}
					
					statusStringArray=pushBackStringArray(statusStringArray,statusString);

					msgjidCount=getXMLElementCount("report","message","jid");
					if(msgjidCount &gt; 0)
						{
							msgjidIndex=0;
							while(1)
							{
							    if(msgjidIndex==msgjidCount)
							    	{
 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
									break;
							    	}

							    msgjid=getXMLText("report","message","jid",msgjidIndex);

							     if(display==gtalk_getMsgJidName(msgjid))
							     	{
									newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									break;
								 }

   							    msgjidIndex=msgjidIndex+1;
							}

							
						}
					else
						newmsgArray = pushBackStringArray(newmsgArray, "no");

					parseResult = gtalk_parseXMLFile(xmlFile);
					
                               print("get friend status:",status,fileshare,display,id);

					index = index + 1;
				}



				msgjidCount=getXMLElementCount("report","message","jid");
				offlineMsgCount=0;
				
				if(msgjidCount &gt; 0)
					{
					msgjidIndex=0;
					while(1)
						{
							 if(msgjidIndex==msgjidCount)
								break;
							 
							msgjid=getXMLText("report","message","jid",msgjidIndex);

							index=0;
							while(1)
								{
								 if(index==onlinefriendCount)
								 	{
								 	offlineMsgCount=Add(offlineMsgCount,1);

										statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, msgjid);
										idArray=pushBackStringArray(idArray, msgjid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									
									break;
								 	}

								 display=getXMLText("report","friend",index,"display");
								 if(display==gtalk_getMsgJidName(msgjid))
								 	break;			
								 index=Add(index,1);
								}
							


							msgjidIndex=Add(msgjidIndex,1);


						}

					}
				







				setFocusItemIndex(0);
				redrawDisplay();
		 


				null;
				}
				else
				{
				print("!!!!!! No friend found !!!!!!");
				setFocusItemIndex(0);
				null;
				}


			}
					
		}

	}
	setFocusItemIndex(0);
	redrawDisplay();
	
</onEnter>
<onRefresh>
  print("-=-=-=-= Enter gtalk -=-=-=-=");

	path = getStoragePath("tmp") + "gtalk_showoffline.dat";
	ifshow= readStringFromFile(path);
	if(ifshow==null)
		showOffline="1";
	else if(ifshow=="yes")
		showOffline="1";
	else
		showOffline="0";

	  xmlFile = gtalk_getUsers();
	  print("get user xml:",xmlFile);


	if (xmlFile != null)
	{
		parseResult = gtalk_parseXMLFile(xmlFile);
		if (parseResult != null)
		{
		self_status=getXMLText("report","self","status");
		self_display=getXMLText("report","self","display");
		self_id=getXMLText("report","self","id");

		self_show=getXMLText("report","self","show");
		self_statusString=getXMLText("report","self","statusString");

	 print("showOffline===",showOffline);

		if(showOffline=="1")
			{
	 				rosterCount=getXMLElementCount("report","roster","item");
					subCount=getXMLElementCount("report","subscription","jid");
					friendCount=Add(rosterCount,subCount);

					tmp_repeatArray=null;
					tmp_repeatArrayCount=0;
					tmp_repeatNum=0;
					onlineFriendCount=getXMLElementCount("report","friend");
					index = 0;
					while(1)
						{
							if(index==onlineFriendCount)
								break;

							tmpDisplay=getXMLText("report","friend",index,"display");

							tmp_repeatIndex=0;
							while(1)
								{
									if(tmp_repeatIndex==tmp_repeatArrayCount)
										{
										tmp_repeatArray=pushBackStringArray(tmp_repeatArray, tmpDisplay);
										tmp_repeatArrayCount=Add(tmp_repeatArrayCount,1);
										break;	
										}

									tmp_repeatDisplay=getStringArrayAt(tmp_repeatArray,tmp_repeatIndex);
									if(tmpDisplay==tmp_repeatDisplay)
										{
										tmp_repeatNum=Add(tmp_repeatNum,1);
										break;
										}
									tmp_repeatIndex=Add(tmp_repeatIndex,1);

								}
							index=Add(index,1);

						}
					
					friendCount=Add(friendCount,tmp_repeatNum);
					
					print("show offline friends--friendCount :: ",friendCount);
						if (friendCount &gt; 0)
						{
							
							
							statusArray=null;
							fileshareArray=null;
							displayArray=null;
							idArray=null;	
							imageArray = null;
							statusStringArray=null;
							fileSharingArray=null;

							newmsgArray=null;

							subCount=getXMLElementCount("report","subscription","jid");
							index = 0;
							while (1)
							{
								if (index == subCount)
									break;

								display=getXMLText("report","subscription","jid",index);

								status="invite you";

								image = "../image/offline.png";
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray,"no");
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, display);					
								imageArray = pushBackStringArray(imageArray, image);
								statusStringArray=pushBackStringArray(statusStringArray," ");
								fileSharingArray=pushBackStringArray(fileSharingArray,"no");

								newmsgArray = pushBackStringArray(newmsgArray, "no");
								
			                               print("get invite friend status:",status,fileshare,display);

								index = index + 1;
							}
						
							
							onlineFriendCount=getXMLElementCount("report","friend");
							index = 0;
							while (1)
							{
								if (index == onlineFriendCount)
									break;

								status=getXMLText("report","friend",index,"status");
								if(status=="5") status="Available";
								if(status=="4") status="busy";
								if(status=="3") status="idle";
								
								fileshare=getXMLText("report","friend",index,"fileshare");
								display=getXMLText("report","friend",index,"display");
								id=getXMLText("report","friend",index,"id");
								image = "../image/gtalker_default.jpg";
								statusString=getXMLText("report","friend",index,"statusString");
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray, fileshare);
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, id);					
								imageArray = pushBackStringArray(imageArray, image);

								fileCount=getXMLElementCount("report","file");
								if(fileCount &gt; 0)
									{
									   fileIndex=0;
									   while(1)
									   	{
									   	  if(fileIndex ==fileCount)
									   	  	{
									   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
											break;
										  	}

										  fileid=getXMLText("report","file",fileIndex,"id");

										  if(fileid==id)
										  	{
										  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
											break;
										  	}
										  fileIndex=Add(fileIndex,1);


									   	}


									}else
										{
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										}
								
									
								statusStringArray=pushBackStringArray(statusStringArray,statusString);

								
								msgjidCount=getXMLElementCount("report","message","jid");
								if(msgjidCount &gt; 0)
									{
										msgjidIndex=0;
										while(1)
										{
										    if(msgjidIndex==msgjidCount)
										    	{
			 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
												break;
										    	}

										    msgjid=getXMLText("report","message","jid",msgjidIndex);

										     if(display==gtalk_getMsgJidName(msgjid))
										     	{
												newmsgArray = pushBackStringArray(newmsgArray, "yes");	

												
												break;
											 }

			   							    msgjidIndex=msgjidIndex+1;
										}

										
									}
								else
									newmsgArray = pushBackStringArray(newmsgArray, "no");

								parseResult = gtalk_parseXMLFile(xmlFile);
								
			                               print("get 111friend status:",status,fileshare,display,id);

								index = index + 1;
							}

							offlineFriendCount=Minus(friendCount,onlineFriendCount);
							offlineFriendCount=Minus(offlineFriendCount,subCount);
							offlineFriendCount=Add(offlineFriendCount,tmp_repeatNum);

							index = 0;
							while(1)
							{
								if (index == friendCount)
									break;	

								jid=getXMLText("report","roster","item",index,"jid");
								subscription=getXMLText("report","roster","item",index,"subscription");
								print("jid===========",jid);
								onlineIndex=0;
								while(1)
									{
										if (onlineIndex == onlineFriendCount)
											break;

										status=getXMLText("report","friend",onlineIndex,"status");
										if(status=="5") status="Available";
										if(status=="4") status="busy";
										if(status=="3") status="idle";
										
										fileshare=getXMLText("report","friend",onlineIndex,"fileshare");
										display=getXMLText("report","friend",onlineIndex,"display");
										id=getXMLText("report","friend",onlineIndex,"id");
										image = "../image/gtalker_default.jpg";

										if(jid==display)
											{
											print("jid==display=============",display);
												break;
											}
										

										
					                               print("get 222friend status:",status,fileshare,display,id);

										onlineIndex = onlineIndex + 1;


									}

								if(onlineIndex == onlineFriendCount)
									{
										if(subscription=="none")
											statusArray=pushBackStringArray(statusArray, "Invited");
										else
											statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, jid);
										idArray=pushBackStringArray(idArray, jid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");


										msgjidCount=getXMLElementCount("report","message","jid");
										if(msgjidCount &gt; 0)
											{
												msgjidIndex=0;
												while(1)
												{
												    if(msgjidIndex==msgjidCount)
												    	{
					 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
														break;
												    	}

												    msgjid=getXMLText("report","message","jid",msgjidIndex);

												     if(jid==gtalk_getMsgJidName(msgjid))
												     	
													{
		newmsgArray = pushBackStringArray(newmsgArray, "yes");

													 
	
														break;
													 
													}


					   							    msgjidIndex=msgjidIndex+1;
												
												}


												
																						}else
	
												newmsgArray = pushBackStringArray(newmsgArray, "no");

										parseResult = gtalk_parseXMLFile(xmlFile);
											}

									
								index=index+1;
								
							}
							
						}

			}
			else
			{
			onlinefriendCount=getXMLElementCount("report","friend");
			subCount=getXMLElementCount("report","subscription","jid");

			msgjidCount=getXMLElementCount("report","message","jid");
			offlineMsgCount=0;
			
			if(msgjidCount &gt; 0)
				{
				msgjidIndex=0;
				while(1)
					{
						 if(msgjidIndex==msgjidCount)
							break;
						msgjid=getXMLText("report","message","jid",msgjidIndex);

						index=0;
						while(1)
							{
							 if(index==onlinefriendCount)
							 	{
							 	offlineMsgCount=Add(offlineMsgCount,1);
								break;
							 	}

							 display=getXMLText("report","friend",index,"display");
							 if(display==gtalk_getMsgJidName(msgjid))
							 	break;			
							 index=Add(index,1);
							}
						


						msgjidIndex=Add(msgjidIndex,1);


					}

				}
			
			
			friendCount=Add(onlinefriendCount,subCount);
			friendCount=Add(friendCount,offlineMsgCount);
			
			print("friendCount :: ",friendCount);
			if (friendCount &gt; 0)
			{

				
				statusArray=null;
				fileshareArray=null;
				displayArray=null;
				idArray=null;	
				imageArray = null;
				statusString=null;
				fileSharingArray=null;
				
				newmsgArray=null;

				subCount=getXMLElementCount("report","subscription","jid");
				index = 0;
				while (1)
				{
					if (index == subCount)
						break;

					display=getXMLText("report","subscription","jid",index);

					status="invite you";

					image = "../image/offline.png";
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray,"no");
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, display);					
					imageArray = pushBackStringArray(imageArray, image);
					statusStringArray=pushBackStringArray(statusStringArray," ");
					fileSharingArray=pushBackStringArray(fileSharingArray,"no");
					
					newmsgArray = pushBackStringArray(newmsgArray, "no");
					
                               print("get invite friend status:",status,fileshare,display);

					index = index + 1;
				}
			

				onlinefriendCount=getXMLElementCount("report","friend");
				index = 0;
				while (1)
				{
					if (index == onlinefriendCount)
						break;



					status=getXMLText("report","friend",index,"status");
					if(status=="5") status="Available";
					if(status=="4") status="busy";
					if(status=="3") status="idle";
					
					fileshare=getXMLText("report","friend",index,"fileshare");
					display=getXMLText("report","friend",index,"display");
					id=getXMLText("report","friend",index,"id");
					image = "../image/gtalker_default.jpg";
					statusString=getXMLText("report","friend",index,"statusString");
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray, fileshare);
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, id);					
					imageArray = pushBackStringArray(imageArray, image);
					
					fileCount=getXMLElementCount("report","file");
					if(fileCount &gt; 0)
						{
						   fileIndex=0;
						   while(1)
						   	{
						   	  if(fileIndex ==fileCount)
						   	  	{
						   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
								break;
							  	}

							  fileid=getXMLText("report","file",fileIndex,"id");

							  if(fileid==id)
							  	{
							  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
								break;
							  	}
							  fileIndex=Add(fileIndex,1);


						   	}


						}else
							{
							fileSharingArray=pushBackStringArray(fileSharingArray,"no");
							}
					
					statusStringArray=pushBackStringArray(statusStringArray,statusString);

					msgjidCount=getXMLElementCount("report","message","jid");
					if(msgjidCount &gt; 0)
						{
							msgjidIndex=0;
							while(1)
							{
							    if(msgjidIndex==msgjidCount)
							    	{
 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
									break;
							    	}

							    msgjid=getXMLText("report","message","jid",msgjidIndex);

							     if(display==gtalk_getMsgJidName(msgjid))
							     	{
									newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									break;
								 }

   							    msgjidIndex=msgjidIndex+1;
							}

							
						}
					else
						newmsgArray = pushBackStringArray(newmsgArray, "no");

					parseResult = gtalk_parseXMLFile(xmlFile);
					
                               print("get friend status:",status,fileshare,display,id);

					index = index + 1;
				}



				msgjidCount=getXMLElementCount("report","message","jid");
				offlineMsgCount=0;
				
				if(msgjidCount &gt; 0)
					{
					msgjidIndex=0;
					while(1)
						{
							 if(msgjidIndex==msgjidCount)
								break;
							 
							msgjid=getXMLText("report","message","jid",msgjidIndex);

							index=0;
							while(1)
								{
								 if(index==onlinefriendCount)
								 	{
								 	offlineMsgCount=Add(offlineMsgCount,1);

										statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, msgjid);
										idArray=pushBackStringArray(idArray, msgjid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									
									break;
								 	}

								 display=getXMLText("report","friend",index,"display");
								 if(display==gtalk_getMsgJidName(msgjid))
								 	break;			
								 index=Add(index,1);
								}
							


							msgjidIndex=Add(msgjidIndex,1);


						}

					}
				







				setFocusItemIndex(0);
				redrawDisplay();
		 


				null;
				}
				else
				{
				print("!!!!!! No friend found !!!!!!");
				setFocusItemIndex(0);
				null;
				}


			}
					
		}

	}
	setFocusItemIndex(0);
	redrawDisplay();
</onRefresh>

<mediaDisplay name=threePartsView

showHeader=no
showDefaultInfo=no



backgroundColor = -1:-1:-1

menuXPC = 6
menuYPC = 37.2
menuWidthPC = 23.3
menuHeightPC = 7.75
menuPerPage=7
selectMenuOnRight=no
autoSelectMenu=no
autoSelectItem=no


forceFocusOnItem=yes

itemImageXPC = 30
itemImageYPC = 26


itemXPC = 31
itemYPC = 26
itemWidthPC = 61.48
itemHeightPC =8.45
itemGap = 0.5
itemPerPage=6
itemBackgroundColor = -1:-1:-1
sideColorLeft = 6:6:6

capWidthPC = 0
capHeightPC = 0

slidingMenuText = yes
slidingItemText = no
rollMenu = yes

itemImageWidthPC = 0
itemImageHeightPC = 0
>

<backgroundDisplay name=gtalk_guide_bg>
	<image offsetXPC=0 offsetYPC=0 widthPC=100 heightPC=100>
	<script>
		if(bg_flag==0)
			{bg_flag=1;
		
		"IMS_Modules/gtalk/image/gtalk_guide_bg.png";}
		else
			null;
	</script>
	</image>
</backgroundDisplay>


<popupDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[CONFIRM]";
			message = "Sorry,Receive Dir not exist or not set";
			btnSize = 1;
			btnString = pushBackStringArray(btnString, "$[OK]");
			
		</onEnter>
	</mediaDisplay>
</popupDialog>


<miniPopupDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[STATUS]";
			message = "GTALK IM STATUS";
			btnSize = 0;

			
		</onEnter>
	</mediaDisplay>
</miniPopupDialog>


<statpopupDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[BUDDY_CHANGE_STATUS]";

			btnSize = 3;
			btnString = pushBackStringArray(btnString, "$[BUDDY_AVAILABLE]");
			btnString = pushBackStringArray(btnString, "$[BUDDY_BUSY]");
			btnString = pushBackStringArray(btnString, "$[BUDDY_IDLE]");
		</onEnter>
	</mediaDisplay>
</statpopupDialog>


<viewpopupDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[view options]";

			btnSize = 3;
			btnString = pushBackStringArray(btnString, "$[view recv dir]");
			btnString = pushBackStringArray(btnString, "$[view save list]");
			btnString = pushBackStringArray(btnString, "$[view share list]");
		</onEnter>
	</mediaDisplay>
</viewpopupDialog>

<deletepopupDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[CONFIRM]";
			message = "$[CONFIRM_REMOVE]";
			btnSize = 2;
			btnString = pushBackStringArray(btnString, "$[YES]");
			btnString = pushBackStringArray(btnString, "$[NO]");
		</onEnter>
	</mediaDisplay>
</deletepopupDialog>

<acceptpopupDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[CONFIRM]";
			message = "$[CONFIRM_ACCEPT]";
			btnSize = 2;
			btnString = pushBackStringArray(btnString, "$[YES]");
			btnString = pushBackStringArray(btnString, "$[NO]");
		</onEnter>
	</mediaDisplay>
</acceptpopupDialog>

<sendtobuddyDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[CONFIRM]";
			message = "$[CONFIRM_SEND]";
			btnSize = 2;
			btnString = pushBackStringArray(btnString, "$[YES]");
			btnString = pushBackStringArray(btnString, "$[NO]");
		</onEnter>
	</mediaDisplay>
</sendtobuddyDialog>


<unsupportDialog>
	<mediaDisplay>
		<onEnter>
			header = "$[CONFIRM]";
			message = "$[BUDDY_NOTSEND]";
			btnSize = 1;
			btnString = pushBackStringArray(btnString, "$[OK]");
		</onEnter>
	</mediaDisplay>
</unsupportDialog>

<idleImage idleImageWidthPC=10 idleImageHeightPC=10> ../image/gtalk_loading_01.png </idleImage>
<idleImage idleImageWidthPC=10 idleImageHeightPC=10> ../image/gtalk_loading_02.png </idleImage>
<idleImage idleImageWidthPC=10 idleImageHeightPC=10> ../image/gtalk_loading_03.png </idleImage>
<idleImage idleImageWidthPC=10 idleImageHeightPC=10> ../image/gtalk_loading_04.png </idleImage>
<idleImage idleImageWidthPC=10 idleImageHeightPC=10> ../image/gtalk_loading_05.png </idleImage>
<idleImage idleImageWidthPC=10 idleImageHeightPC=10> ../image/gtalk_loading_06.png </idleImage>

<!--
<image redraw=yes offsetXPC=6 offsetYPC=10 widthPC=18 heightPC=7.5 useBackgroundSurface="yes">
../image/p2_logo.png
</image>
-->


<text offsetXPC=24  offsetYPC=78.5 widthPC=65 heightPC=15 fontSize=12  backgroundColor=-1:-1:-1 foregroundColor=172:173:174 >
$[BUDDY_REMOVE_ACCEPT]
</text>

<image offsetXPC=22 offsetYPC=84.5   widthPC=2  heightPC=3.2>
../image/option_red.png
</image>



<text offsetXPC=55 offsetYPC=78.5  widthPC=60 heightPC=15  fontSize=12   backgroundColor=-1:-1:-1 foregroundColor=172:173:174>
$[MESSAGE_WAIT]
</text>

<image offsetXPC=51.5 offsetYPC=84 widthPC=3.5 heightPC=4.5> 
../image/newmsg.png
</image>

<text offsetXPC=72.5  offsetYPC=78.5 widthPC=65 heightPC=15 fontSize=12  backgroundColor=-1:-1:-1 foregroundColor=172:173:174 >
$[SHARE_OK]
</text>


<image offsetXPC=70 offsetYPC=84 widthPC=2.3 heightPC=4.5> 
../image/file.png
</image>



<text offsetXPC=86.9 offsetYPC=78.5 widthPC=65 heightPC=15 fontSize=12  backgroundColor=-1:-1:-1 foregroundColor=172:173:174 >
$[SHARING]
</text>


<image offsetXPC=84 offsetYPC=84 widthPC=2.7 heightPC=4>
../image/sharingfile.png
</image>

<text offsetXPC="7.5" offsetYPC="32.5" widthPC="23" heightPC="5" fontSize=21  backgroundColor=-1:-1:-1 foregroundColor=158:158:158    >
<script>
gtalk_getShortName(self_display);
</script>
</text>


<image  offsetXPC=4.8 offsetYPC=33.1  widthPC=2.4 heightPC=4>
<script>
if(self_show=="Available")
	self_status_image="../image/gtalk_available.png";
if(self_show=="Busy")
	self_status_image="../image/gtalk_busy.png";
if(self_show=="Idle")
	self_status_image="../image/gtalk_idle.png";

self_status_image;

</script>
</image>





<text redraw=no useBackgroundSurface=yes  offsetXPC=87 offsetYPC=11 widthPC=5 heightPC=15 fontSize=18 backgroundColor=-1:-1:-1 foregroundColor=245:245:245>
<script>
msgjidCount;
</script>
</text>


<image  offsetXPC=82 offsetYPC=16  widthPC=4  heightPC=5 > 
../image/newmsg.png
</image>

<text offsetXPC=43 offsetYPC=13 widthPC=65 heightPC=15 fontSize=16 backgroundColor=-1:-1:-1 foregroundColor=255:255:255>
<script>
"$[SELECT_BUDDY]";
</script>
</text>

<scrollbar redraw=yes offsetXPC=93 offsetYPC=23 widthPC=2 heightPC=56 foregroundImage="../image/slidebar_inside.png" border=5 offset=32 direction="vertical">
	<backgroundImage>
		<script>
			focusIndex = getFocusItemIndex();
			maxIndex = friendCount - 1;

			image = "../image/Slidebar_up_down.png";
			if (focusIndex == 0) {
				image = "IMS_Modules/gtalk/image/Slidebar_down.png";
			}
			else if (focusIndex == maxIndex) {
				image = "IMS_Modules/gtalk/image/Slidebar_up.png";
			}
			image;
		</script>
	</backgroundImage>
	<totalSize>
		<script>
			friendCount;
		</script>
	</totalSize>
	<startIndex>
		<script>
			getFocusItemIndex();
		</script>
	</startIndex>
</scrollbar>

<menuDisplay>
<text offsetXPC=0 offsetYPC=0 widthPC=100 heightPC=100 useBackgroundSurface=yes/>
	<image offsetXPC=0 offsetYPC=0 widthPC=100 heightPC=100>
		<script>
			index1 = getFocusMenuIndex();
			index2 = getQueryMenuIndex();
			context = getPageInfo("majorContext");
			if (index1 == index2)
			{
				if (context == "menu")
				{
					"../image/leftbar_select.png";
				}
				else
				{
					null;
				}
			}
			else
			{
				null;
			}
		</script>
	</image>
	
	<text align=left offsetXPC=2 offsetYPC=3 widthPC=96 heightPC=96  backgroundColor=-1:-1:-1>
		<fontSize>
			<script>
				if(getQueryMenuIndex()==0)
					size=15;
				else
					size=16;
			</script>
		</fontSize>
		
		<foregroundColor>
			<script>
				if(getQueryMenuIndex()==0)
					color="42:164:222";
				else
					color="222:229:244";
			</script>
		</foregroundColor>	
		
		<script>
			index = getQueryMenuIndex();
		
		 if(index==0)
		 	{
 self_statusString;
		 	}
		 else if(index==1)
		 	{
"$[BUDDY_CHANGE_STATUS]";

		 	}
		  else if(index==2)
		  	{
 "$[ADD_A_BUDDY]";
		  	}
		  else if(index==3)
		  	{
"$[IMS_SETTINGS]";
		  	}
		   else if(index==4)
		  	{
"$[LOGOUT]";
		  	}
				
		</script>
	</text>
</menuDisplay>

<itemDisplay>
	<text offsetXPC=0 offsetYPC=0 widthPC=100 heightPC=100 useBackgroundSurface=yes/>

	<image offsetXPC=0 offsetYPC=0 widthPC=100 heightPC=100>
	<script>
		status = getDrawingItemState();
		if (status == "focus")
		{
			"../image/gtalk_guide_select.png";
		}
		else
			{
			null;
			}

	</script>
	</image>

<text offsetXPC=20 offsetYPC=21 widthPC=100 heightPC=50 fontSize=18 backgroundColor=-1:-1:-1  foregroundColor=200:200:200>
<script>
gtalk_getShortName(getStringArrayAt(displayArray , -1));
</script>
</text>
<text offsetXPC=55 offsetYPC=23 widthPC=42 heightPC=50 fontSize=15 backgroundColor=-1:-1:-1  foregroundColor=42:164:222>
<script>
status_str=getStringArrayAt(statusStringArray , -1);
status_str;
</script>
</text>


<image offsetXPC=10  offsetYPC=42 widthPC=3  heightPC=50>
<script>
	fileshare=getStringArrayAt(fileshareArray , -1);

	if(fileshare == "yes")
	{
		face = "../image/file.png";
	}else
		face =null;		

	face;
</script>
	
</image>


<image offsetXPC=2 offsetYPC=22 widthPC=7.4 heightPC=75>
<script>
	newmsg=getStringArrayAt(newmsgArray , -1);
	status_str=getStringArrayAt(statusArray , -1);
	
	if(newmsg == "yes")
	{

		if(status_str == "Available")
		{
			face = "../image/newmsg_available.png";
		}else
			if(status_str == "busy")
		{
			face = "../image/newmsg_busy.png";
		}else
			if(status_str == "idle")
		{
			face = "../image/newmsg_idle.png";
		}else
			if(status_str == "Offline")
		{
			face = "../image/newmsg_offline.png";
		}else
			if(status_str == "Invited")
		{
			face = "../image/newmsg_question.png";
		}else
			if(status_str == "invite you")
		{
			face = "../image/newmsg_question.png";
		}else
			face = "../image/newmsg_offline.png";		

		
	}
	else
		{

			if(status_str == "Available")
			{
				face = "../image/nomsg_available.png";
			}else
				if(status_str == "busy")
			{
				face = "../image/nomsg_busy.png";
			}else
				if(status_str == "idle")
			{
				face = "../image/nomsg_idle.png";
			}else
				if(status_str == "Offline")
			{
				face = "../image/nomsg_offline.png";
			}else
				if(status_str == "Invited")
			{
				face = "../image/nomsg_question.png";
			}else
				if(status_str == "invite you")
			{
				face = "../image/nomsg_question.png";
			}else
				face = "../image/nomsg_offline.png";		


		}
	

	face;
</script>
	
</image>

<image offsetXPC=13.5 offsetYPC=42 widthPC=4 heightPC=50>
<script>
	sharing=getStringArrayAt(fileSharingArray , -1);
	if(sharing == "yes")
	{
		face = "../image/sharingfile.png";
	}else
		face =null;		

	face;
</script>
	
</image>

</itemDisplay>






<onUserInput>
<script>
userInput = currentUserInput();
print("Catch input: ", userInput);
focusCtx = getPageInfo("majorContext");

if(userInput=="up"||userInput=="down")
{
 "false";
}
else
{
if (focusCtx == "items" &amp;&amp; userInput == "right")
{
	print("Ignore right key");
	"true";
}
else if (focusCtx == "items" &amp;&amp; userInput == "option_red")
{
  	 print("enter display key,delet focus  friend !!!",getFocusItemIndex());

	itemFocusIndex=getFocusItemIndex();
	print("itemFocusIndex==",itemFocusIndex);
	status=getStringArrayAt(statusArray,itemFocusIndex);
	jid=getStringArrayAt(displayArray,itemFocusIndex);
	print("FocusFriend status==",status);
	
 	if(status!="invite you")
 		{
		   rss = "./IMS_Modules/gtalk/scripts/popupDialog.rss";
		   confirm = doModalRss(rss, "mediaDisplay", "deletepopupDialog", 0);
   
  		   if (confirm == "$[YES]")
			  {
				print("****enter  YES  ***********");
				
				ret=gtalk_rosterCmd("remove",jid);
				print("gtalk_rosterCmd--remove-----ret=",ret);				

				imArray=null;
				imArray=pushBackStringArray(imArray, "roster");
				imArray=pushBackStringArray(imArray, jid);
				imArray=pushBackStringArray(imArray,"remove");
									
				path = getStoragePath("tmp") + "im_status.dat";
				writeStringToFile(path, imArray);
				PostMessage("im_status");
				


					
				}  
 		}
	       else
		   	if(status=="invite you")
			{

			   rss = "./IMS_Modules/gtalk/scripts/popupDialog.rss";
			   confirm = doModalRss(rss, "mediaDisplay", "acceptpopupDialog", 0);
   
	  		   if (confirm == "$[YES]")
				  {
					print("****enter  YES  ***********");
					ret=gtalk_rosterCmd("accept",jid);
					print("gtalk_rosterCmd--accept-----ret=",ret);

					imArray=null;
					imArray=pushBackStringArray(imArray, "roster");
					imArray=pushBackStringArray(imArray, jid);
					imArray=pushBackStringArray(imArray,"accept");
										
					path = getStoragePath("tmp") + "im_status.dat";
					writeStringToFile(path, imArray);
					
					PostMessage("im_status");


	  		   	  }else
	  		   	   	if (confirm == "$[NO]")
	  		   	   		{
							print("****enter  NO  ***********");
							ret=gtalk_rosterCmd("decline",jid);
							print("gtalk_rosterCmd-decline------ret=",ret);

							imArray=null;
							imArray=pushBackStringArray(imArray, "roster");
							imArray=pushBackStringArray(imArray,jid);
							imArray=pushBackStringArray(imArray,"decline");
												
							path = getStoragePath("tmp") + "im_status.dat";
							writeStringToFile(path, imArray);
							
							PostMessage("im_status");

						}
			   
		   	}

 		
   "true";

}	
else if(userInput == "im_status")
{
	print("get im_status");

	path = getStoragePath("tmp") + "im_status.dat";
      im_status = readStringFromFile(path);

	 friendid = getStringArrayAt(im_status, 1);
	 changestat=getStringArrayAt(im_status, 2);
	 print("im_status friendid===========",friendid);
	 print("im_status changestat===========",changestat);

	if(changestat=="3")  changestat="$[BUDDY_IDLE]";
	if(changestat=="4")  changestat="$[BUDDY_BUSY]";
	if(changestat=="5")  changestat="$[BUDDY_AVAILABLE]";
	if(changestat=="0")  changestat="$[BUDDY_OFFLINE]";
	if(changestat=="10")  changestat="$[INVITE_YOU]";

	if(changestat=="decline")
		imstatus_str="$[DECLINE_ADD] "+friendid+" $[AS_FRIEND]";
	else
		if(changestat=="accept")
			imstatus_str="$[ACCEPT_ADD] "+friendid+" $[AS_FRIEND]";	
	else
		if(changestat=="remove")
			imstatus_str="$[REMOVE_BUDDY]  "+friendid+" $[FROM_LIST]";
	else
		if(changestat=="invite")
			imstatus_str="$[YOU_INVITE]  "+friendid+" $[AS_FRIEND]";
	else
		imstatus_str=friendid+" $[CHANGE_TO] "+changestat;
	
	path = getStoragePath("tmp") + "im_tmpstatus.dat";
	writeStringToFile(path, imstatus_str);

    if(changestat!="msg")
    	{
	rss = "./IMS_Modules/gtalk/scripts/miniPopupDialog.rss";
	confirm = doModalRss(rss);
    	}

	print("-=-=-=-= Enter gtalk -=-=-=-=");

	path = getStoragePath("tmp") + "gtalk_showoffline.dat";
	ifshow= readStringFromFile(path);
	if(ifshow==null)
		showOffline="1";
	else if(ifshow=="yes")
		showOffline="1";
	else
		showOffline="0";

	  xmlFile = gtalk_getUsers();
	  print("get user xml:",xmlFile);


	if (xmlFile != null)
	{
		parseResult = gtalk_parseXMLFile(xmlFile);
		if (parseResult != null)
		{
		msgjidCount=getXMLElementCount("report","message","jid");

		self_status=getXMLText("report","self","status");
		self_display=getXMLText("report","self","display");
		self_id=getXMLText("report","self","id");

		self_show=getXMLText("report","self","show");
		self_statusString=getXMLText("report","self","statusString");

	 print("showOffline===",showOffline);

		if(showOffline=="1")
			{
	 				rosterCount=getXMLElementCount("report","roster","item");
					subCount=getXMLElementCount("report","subscription","jid");
					friendCount=Add(rosterCount,subCount);

					tmp_repeatArray=null;
					tmp_repeatArrayCount=0;
					tmp_repeatNum=0;
					onlineFriendCount=getXMLElementCount("report","friend");
					index = 0;
					while(1)
						{
							if(index==onlineFriendCount)
								break;

							tmpDisplay=getXMLText("report","friend",index,"display");

							tmp_repeatIndex=0;
							while(1)
								{
									if(tmp_repeatIndex==tmp_repeatArrayCount)
										{
										tmp_repeatArray=pushBackStringArray(tmp_repeatArray, tmpDisplay);
										tmp_repeatArrayCount=Add(tmp_repeatArrayCount,1);
										break;	
										}

									tmp_repeatDisplay=getStringArrayAt(tmp_repeatArray,tmp_repeatIndex);
									if(tmpDisplay==tmp_repeatDisplay)
										{
										tmp_repeatNum=Add(tmp_repeatNum,1);
										break;
										}
									tmp_repeatIndex=Add(tmp_repeatIndex,1);

								}
							index=Add(index,1);

						}
					
					friendCount=Add(friendCount,tmp_repeatNum);
					
					print("show offline friends--friendCount :: ",friendCount);
						if (friendCount &gt; 0)
						{
							
							
							statusArray=null;
							fileshareArray=null;
							displayArray=null;
							idArray=null;	
							imageArray = null;
							statusStringArray=null;
							fileSharingArray=null;

							newmsgArray=null;

							subCount=getXMLElementCount("report","subscription","jid");
							index = 0;
							while (1)
							{
								if (index == subCount)
									break;

								display=getXMLText("report","subscription","jid",index);

								status="invite you";

								image = "../image/offline.png";
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray,"no");
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, display);					
								imageArray = pushBackStringArray(imageArray, image);
								statusStringArray=pushBackStringArray(statusStringArray," ");
								fileSharingArray=pushBackStringArray(fileSharingArray,"no");

								newmsgArray = pushBackStringArray(newmsgArray, "no");
								
			                               print("get invite friend status:",status,fileshare,display);

								index = index + 1;
							}
						
							
							onlineFriendCount=getXMLElementCount("report","friend");
							index = 0;
							while (1)
							{
								if (index == onlineFriendCount)
									break;

								status=getXMLText("report","friend",index,"status");
								if(status=="5") status="Available";
								if(status=="4") status="busy";
								if(status=="3") status="idle";
								
								fileshare=getXMLText("report","friend",index,"fileshare");
								display=getXMLText("report","friend",index,"display");
								id=getXMLText("report","friend",index,"id");
								image = "../image/gtalker_default.jpg";
								statusString=getXMLText("report","friend",index,"statusString");
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray, fileshare);
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, id);					
								imageArray = pushBackStringArray(imageArray, image);

								fileCount=getXMLElementCount("report","file");
								if(fileCount &gt; 0)
									{
									   fileIndex=0;
									   while(1)
									   	{
									   	  if(fileIndex ==fileCount)
									   	  	{
									   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
											break;
										  	}

										  fileid=getXMLText("report","file",fileIndex,"id");

										  if(fileid==id)
										  	{
										  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
											break;
										  	}
										  fileIndex=Add(fileIndex,1);


									   	}


									}else
										{
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										}
								
									
								statusStringArray=pushBackStringArray(statusStringArray,statusString);

								
								msgjidCount=getXMLElementCount("report","message","jid");
								if(msgjidCount &gt; 0)
									{
										msgjidIndex=0;
										while(1)
										{
										    if(msgjidIndex==msgjidCount)
										    	{
			 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
												break;
										    	}

										    msgjid=getXMLText("report","message","jid",msgjidIndex);

										     if(display==gtalk_getMsgJidName(msgjid))
										     	{
												newmsgArray = pushBackStringArray(newmsgArray, "yes");	

												
												break;
											 }

			   							    msgjidIndex=msgjidIndex+1;
										}

										
									}
								else
									newmsgArray = pushBackStringArray(newmsgArray, "no");

								parseResult = gtalk_parseXMLFile(xmlFile);
								
			                               print("get 111friend status:",status,fileshare,display,id);

								index = index + 1;
							}

							offlineFriendCount=Minus(friendCount,onlineFriendCount);
							offlineFriendCount=Minus(offlineFriendCount,subCount);
							offlineFriendCount=Add(offlineFriendCount,tmp_repeatNum);

							index = 0;
							while(1)
							{
								if (index == friendCount)
									break;	

								jid=getXMLText("report","roster","item",index,"jid");
								subscription=getXMLText("report","roster","item",index,"subscription");
								print("jid===========",jid);
								onlineIndex=0;
								while(1)
									{
										if (onlineIndex == onlineFriendCount)
											break;

										status=getXMLText("report","friend",onlineIndex,"status");
										if(status=="5") status="Available";
										if(status=="4") status="busy";
										if(status=="3") status="idle";
										
										fileshare=getXMLText("report","friend",onlineIndex,"fileshare");
										display=getXMLText("report","friend",onlineIndex,"display");
										id=getXMLText("report","friend",onlineIndex,"id");
										image = "../image/gtalker_default.jpg";

										if(jid==display)
											{
											print("jid==display=============",display);
												break;
											}
										

										
					                               print("get 222friend status:",status,fileshare,display,id);

										onlineIndex = onlineIndex + 1;


									}

								if(onlineIndex == onlineFriendCount)
									{
										if(subscription=="none")
											statusArray=pushBackStringArray(statusArray, "Invited");
										else
											statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, jid);
										idArray=pushBackStringArray(idArray, jid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");


										msgjidCount=getXMLElementCount("report","message","jid");
										if(msgjidCount &gt; 0)
											{
												msgjidIndex=0;
												while(1)
												{
												    if(msgjidIndex==msgjidCount)
												    	{
					 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
														break;
												    	}

												    msgjid=getXMLText("report","message","jid",msgjidIndex);

												     if(jid==gtalk_getMsgJidName(msgjid))
												     	
													{
		newmsgArray = pushBackStringArray(newmsgArray, "yes");

													 
	
														break;
													 
													}


					   							    msgjidIndex=msgjidIndex+1;
												
												}


												
																						}else
	
												newmsgArray = pushBackStringArray(newmsgArray, "no");

										parseResult = gtalk_parseXMLFile(xmlFile);
											}

									
								index=index+1;
								
							}
							
						}

			}
			else
			{
			onlinefriendCount=getXMLElementCount("report","friend");
			subCount=getXMLElementCount("report","subscription","jid");

			msgjidCount=getXMLElementCount("report","message","jid");
			offlineMsgCount=0;
			
			if(msgjidCount &gt; 0)
				{
				msgjidIndex=0;
				while(1)
					{
						 if(msgjidIndex==msgjidCount)
							break;
						msgjid=getXMLText("report","message","jid",msgjidIndex);

						index=0;
						while(1)
							{
							 if(index==onlinefriendCount)
							 	{
							 	offlineMsgCount=Add(offlineMsgCount,1);
								break;
							 	}

							 display=getXMLText("report","friend",index,"display");
							 if(display==gtalk_getMsgJidName(msgjid))
							 	break;			
							 index=Add(index,1);
							}
						


						msgjidIndex=Add(msgjidIndex,1);


					}

				}
			
			
			friendCount=Add(onlinefriendCount,subCount);
			friendCount=Add(friendCount,offlineMsgCount);
			
			print("friendCount :: ",friendCount);
			if (friendCount &gt; 0)
			{

				
				statusArray=null;
				fileshareArray=null;
				displayArray=null;
				idArray=null;	
				imageArray = null;
				statusString=null;
				fileSharingArray=null;
				
				newmsgArray=null;

				subCount=getXMLElementCount("report","subscription","jid");
				index = 0;
				while (1)
				{
					if (index == subCount)
						break;

					display=getXMLText("report","subscription","jid",index);

					status="invite you";

					image = "../image/offline.png";
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray,"no");
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, display);					
					imageArray = pushBackStringArray(imageArray, image);
					statusStringArray=pushBackStringArray(statusStringArray," ");
					fileSharingArray=pushBackStringArray(fileSharingArray,"no");
					
					newmsgArray = pushBackStringArray(newmsgArray, "no");
					
                               print("get invite friend status:",status,fileshare,display);

					index = index + 1;
				}
			

				onlinefriendCount=getXMLElementCount("report","friend");
				index = 0;
				while (1)
				{
					if (index == onlinefriendCount)
						break;



					status=getXMLText("report","friend",index,"status");
					if(status=="5") status="Available";
					if(status=="4") status="busy";
					if(status=="3") status="idle";
					
					fileshare=getXMLText("report","friend",index,"fileshare");
					display=getXMLText("report","friend",index,"display");
					id=getXMLText("report","friend",index,"id");
					image = "../image/gtalker_default.jpg";
					statusString=getXMLText("report","friend",index,"statusString");
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray, fileshare);
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, id);					
					imageArray = pushBackStringArray(imageArray, image);
					
					fileCount=getXMLElementCount("report","file");
					if(fileCount &gt; 0)
						{
						   fileIndex=0;
						   while(1)
						   	{
						   	  if(fileIndex ==fileCount)
						   	  	{
						   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
								break;
							  	}

							  fileid=getXMLText("report","file",fileIndex,"id");

							  if(fileid==id)
							  	{
							  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
								break;
							  	}
							  fileIndex=Add(fileIndex,1);


						   	}


						}else
							{
							fileSharingArray=pushBackStringArray(fileSharingArray,"no");
							}
					
					statusStringArray=pushBackStringArray(statusStringArray,statusString);

					msgjidCount=getXMLElementCount("report","message","jid");
					if(msgjidCount &gt; 0)
						{
							msgjidIndex=0;
							while(1)
							{
							    if(msgjidIndex==msgjidCount)
							    	{
 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
									break;
							    	}

							    msgjid=getXMLText("report","message","jid",msgjidIndex);

							     if(display==gtalk_getMsgJidName(msgjid))
							     	{
									newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									break;
								 }

   							    msgjidIndex=msgjidIndex+1;
							}

							
						}
					else
						newmsgArray = pushBackStringArray(newmsgArray, "no");

					parseResult = gtalk_parseXMLFile(xmlFile);
					
                               print("get friend status:",status,fileshare,display,id);

					index = index + 1;
				}



				msgjidCount=getXMLElementCount("report","message","jid");
				offlineMsgCount=0;
				
				if(msgjidCount &gt; 0)
					{
					msgjidIndex=0;
					while(1)
						{
							 if(msgjidIndex==msgjidCount)
								break;
							 
							msgjid=getXMLText("report","message","jid",msgjidIndex);

							index=0;
							while(1)
								{
								 if(index==onlinefriendCount)
								 	{
								 	offlineMsgCount=Add(offlineMsgCount,1);

										statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, msgjid);
										idArray=pushBackStringArray(idArray, msgjid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									
									break;
								 	}

								 display=getXMLText("report","friend",index,"display");
								 if(display==gtalk_getMsgJidName(msgjid))
								 	break;			
								 index=Add(index,1);
								}
							


							msgjidIndex=Add(msgjidIndex,1);


						}

					}
				







				setFocusItemIndex(0);
				redrawDisplay();
		 


				null;
				}
				else
				{
				print("!!!!!! No friend found !!!!!!");
				setFocusItemIndex(0);
				null;
				}


			}
					
		}

	}
	setFocusItemIndex(0);
	redrawDisplay();
	"true";
}
else if(userInput == "im_file_status")
{
	print("get im_file_status");
	
	path = getStoragePath("tmp") + "im_file_status.dat";
      im_file_status = readStringFromFile(path);

	 file_action = getStringArrayAt(im_file_status, 1);
	 action_id=getStringArrayAt(im_file_status, 2);




	 if(file_action=="start") 		imstatus_str="$[FILE_RECV_START] "+action_id;
	 if(file_action=="cancelrcv") 	imstatus_str="$[CANCEL_RECVSHARE] "+action_id;
	 if(file_action=="cancelsnd") imstatus_str="$[CANCEL_SENDSHARE] "+action_id;
	 if(file_action=="donesnd") 	imstatus_str="$[FILE_SEND_DONE] "+action_id;
	 if(file_action=="donercv") 	
	 	{

		action_dir=getStringArrayAt(im_file_status, 3);
	 	imstatus_str="$[FILE_RECV_DONE] "+gtalk_getDiskString(action_dir);

	 	}
	path = getStoragePath("tmp") + "im_tmpstatus.dat";
	writeStringToFile(path, imstatus_str);


	rss = "./IMS_Modules/gtalk/scripts/miniPopupDialog.rss";
	confirm = doModalRss(rss);


	imArray=null;
	imArray=pushBackStringArray(imArray, "im_msg_txt");
	imArray=pushBackStringArray(imArray, im_jid);
	imArray=pushBackStringArray(imArray,"msg");

	path = getStoragePath("tmp") + "im_status.dat";
	writeStringToFile(path, imArray);
	PostMessage("im_status");
	



	"true";
}
else if(userInput == "im_msg_txt")
{
	print("get im_msg_txt");
	
	path = getStoragePath("tmp") + "im_msg_txt.dat";
      im_msg_txt = readStringFromFile(path);

	 im_jid = getStringArrayAt(im_msg_txt, 1);
	 
	 im_msg=null;
	 index=2;
	 while(1)
	 {
		str=getStringArrayAt(im_msg_txt, index);
		if(str==null)
			break;
		
		index=Add(index,1);		

		tmpstr=getStringArrayAt(im_msg_txt, index);
		if(tmpstr==null)
		{
		im_msg=im_msg+str;
		break;
		}
		else
		{
		print("str=========",str);
		 im_msg=pushBackStringArray(im_msg,str);
		 print("im_msg=========",im_msg);
		}



	 }

	  
	 print("==============im_msg=",im_msg);
	 
	imstatus_str="$[NEW_MSG_FROM] "+im_jid+") --[ \""+im_msg+"\"]";
		
	 path = getStoragePath("tmp") + "im_tmpstatus.dat";
	writeStringToFile(path, imstatus_str);

	path = getStoragePath("tmp") + "gtalk_to_friend.dat";
      friendDisplay = readStringFromFile(path);

	imArray=null;
	imArray=pushBackStringArray(imArray, "im_msg_txt");
	imArray=pushBackStringArray(imArray, im_jid);
	imArray=pushBackStringArray(imArray,"msg");

	path = getStoragePath("tmp") + "im_status.dat";
	writeStringToFile(path, imArray);


	rss = "./IMS_Modules/gtalk/scripts/miniPopupDialog.rss";
	confirm = doModalRss(rss);
	PostMessage("im_status");
	
	"true";
}
else
	"false";

}


</script>
</onUserInput>

</mediaDisplay>

<jumpLink>
<link>
"rss_file://./guide_menu/scripts/GuideMenu.rss"
</link>
</jumpLink>


<jumpLinkToFriend>
<link>
gtalk_friend.rss
</link>
</jumpLinkToFriend>


<jumpLinkToSetting>
<link>
gtalk_showoptions.rss
</link>
</jumpLinkToSetting>

<menu_template>
<displayTitle>
<script>
queryIndex = getQueryMenuIndex();
</script>
</displayTitle>
<onClick>
index = getFocusMenuIndex();
if(index==0)
	{
		inputInfo = getInput("info");
		redrawDisplay();	
		if (inputInfo != null)
		{
		  	 self_statusString = inputInfo;
		      	 gtalk_setMyStatus(NULL,self_statusString);
			 redrawDisplay();
		}
	}
else if(index==1)	
	{
		rss = "./IMS_Modules/gtalk/scripts/statpopDialog.rss";
		confirm = doModalRss(rss, "mediaDisplay", "statpopupDialog", 0);
		print("confirm-============",confirm);

		if(confirm=="$[BUDDY_AVAILABLE]")
			self_show="Available";
		if(confirm=="$[BUDDY_BUSY]")
			self_show="Busy";
		if(confirm=="$[BUDDY_IDLE]")
			self_show="Idle";

		gtalk_setMyStatus(self_show,NULL);
	}
else if(index==2)	
	{
		inputInfo = getInput("userName");
		redrawDisplay();
		if (inputInfo != null)
		{
		   addFriendName = inputInfo;
		 print("===========add friend ====",addFriendName);

		 jid=addFriendName+"@gmail.com";
		 ret=gtalk_rosterCmd("invite",jid);
		 print("===gtalk_rosterCmd===invite======ret==",ret);

		imArray=null;
		imArray=pushBackStringArray(imArray, "roster");
		imArray=pushBackStringArray(imArray, jid);
		imArray=pushBackStringArray(imArray,"invite");
							
		path = getStoragePath("tmp") + "im_status.dat";
		writeStringToFile(path, imArray);
		PostMessage("im_status");		 	
		redrawDisplay();
		}
	}
else if(index==3)	
	{
	jumpToLink("jumpLinkToSetting");
	}
else if(index==4)	
	{
		 result = googleServiceLogin("logout","gtalk");

		postMessage("return");
	}

null;	
</onClick>
</menu_template>




<onExit>
	print("-=-=-=-= Exit from gtalk -=-=-=-=");
        status = gtalk_getMyStatus();
        if (status == "SIGNEDIN") {
             	 PostMessage("switch_ap","GBrowserGridViewAP");
        }
</onExit>

<script>
        status = gtalk_getMyStatus();
        if (status != "SIGNEDIN") {
			print("111111111113333333333333333");
             	postMessage("guide");
        }


	path =  getStoragePath("key") + "gtalk_sendtobuddy.dat";
	sendbuddy= readStringFromFile(path);
	if(sendbuddy!=null)
		{
			jumpToLink("jumpLinkToFriend");
		}

	
		
	path = getStoragePath("tmp") + "gtalk_showoffline.dat";
	ifshow= readStringFromFile(path);
	if(ifshow==null)
		showOffline="1";
	else if(ifshow=="yes")
		showOffline="1";
	else
		showOffline="0";



	print("-=-=-=-= Enter gtalk -=-=-=-=");


	  xmlFile = gtalk_getUsers();

	  print("get user xml:",xmlFile);


	if (xmlFile != null)
	{
		parseResult = gtalk_parseXMLFile(xmlFile);
		if (parseResult != null)
		{
		msgjidCount=getXMLElementCount("report","message","jid");
		self_status=getXMLText("report","self","status");
		self_display=getXMLText("report","self","display");
		self_id=getXMLText("report","self","id");

		self_show=getXMLText("report","self","show");
		self_statusString=getXMLText("report","self","statusString");

	 print("showOffline===",showOffline);

		if(showOffline=="1")
			{
	 				rosterCount=getXMLElementCount("report","roster","item");
					subCount=getXMLElementCount("report","subscription","jid");
					friendCount=Add(rosterCount,subCount);

					
					tmp_repeatArray=null;
					tmp_repeatArrayCount=0;
					tmp_repeatNum=0;
					onlineFriendCount=getXMLElementCount("report","friend");
					index = 0;
					while(1)
						{
							if(index==onlineFriendCount)
								break;

							tmpDisplay=getXMLText("report","friend",index,"display");

							tmp_repeatIndex=0;
							while(1)
								{
									if(tmp_repeatIndex==tmp_repeatArrayCount)
										{
										tmp_repeatArray=pushBackStringArray(tmp_repeatArray, tmpDisplay);
										tmp_repeatArrayCount=Add(tmp_repeatArrayCount,1);
										break;	
										}

									tmp_repeatDisplay=getStringArrayAt(tmp_repeatArray,tmp_repeatIndex);
									if(tmpDisplay==tmp_repeatDisplay)
										{
										tmp_repeatNum=Add(tmp_repeatNum,1);
										break;
										}
									tmp_repeatIndex=Add(tmp_repeatIndex,1);

								}
							index=Add(index,1);

						}
					
					friendCount=Add(friendCount,tmp_repeatNum);
					


	
					print("show offline friends--friendCount :: ",friendCount);
						if (friendCount &gt; 0)
						{
							
							
							statusArray=null;
							fileshareArray=null;
							displayArray=null;
							idArray=null;	
							imageArray = null;
							statusStringArray=null;
							fileSharingArray=null;

							newmsgArray=null;

							subCount=getXMLElementCount("report","subscription","jid");
							index = 0;
							while (1)
							{
								if (index == subCount)
									break;

								display=getXMLText("report","subscription","jid",index);

								status="invite you";

								image = "../image/offline.png";
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray,"no");
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, display);					
								imageArray = pushBackStringArray(imageArray, image);
								statusStringArray=pushBackStringArray(statusStringArray," ");
								fileSharingArray=pushBackStringArray(fileSharingArray,"no");

								newmsgArray = pushBackStringArray(newmsgArray, "no");
								
			                               print("get invite friend status:",status,fileshare,display);

								index = index + 1;
							}
						
							
							onlineFriendCount=getXMLElementCount("report","friend");
							index = 0;
							while (1)
							{
								if (index == onlineFriendCount)
									break;

								status=getXMLText("report","friend",index,"status");
								if(status=="5") status="Available";
								if(status=="4") status="busy";
								if(status=="3") status="idle";
								
								fileshare=getXMLText("report","friend",index,"fileshare");
								display=getXMLText("report","friend",index,"display");
								id=getXMLText("report","friend",index,"id");
								image = "../image/gtalker_default.jpg";
								statusString=getXMLText("report","friend",index,"statusString");
				
					
								statusArray=pushBackStringArray(statusArray, status);
								fileshareArray=pushBackStringArray(fileshareArray, fileshare);
								displayArray=pushBackStringArray(displayArray, display);
								idArray=pushBackStringArray(idArray, id);					
								imageArray = pushBackStringArray(imageArray, image);

								fileCount=getXMLElementCount("report","file");
								if(fileCount &gt; 0)
									{
									   fileIndex=0;
									   while(1)
									   	{
									   	  if(fileIndex ==fileCount)
									   	  	{
									   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
											break;
										  	}

										  fileid=getXMLText("report","file",fileIndex,"id");

										  if(fileid==id)
										  	{
										  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
											break;
										  	}
										  fileIndex=Add(fileIndex,1);


									   	}


									}else
										{
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										}
								
									
								statusStringArray=pushBackStringArray(statusStringArray,statusString);

								
								msgjidCount=getXMLElementCount("report","message","jid");
								if(msgjidCount &gt; 0)
									{
										msgjidIndex=0;
										while(1)
										{
										    if(msgjidIndex==msgjidCount)
										    	{
			 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
												break;
										    	}

										    msgjid=getXMLText("report","message","jid",msgjidIndex);

										     if(display==gtalk_getMsgJidName(msgjid))
										     	{
												newmsgArray = pushBackStringArray(newmsgArray, "yes");	


												break;
											 }

			   							    msgjidIndex=msgjidIndex+1;
										}

										
									}
								else
									newmsgArray = pushBackStringArray(newmsgArray, "no");

								parseResult = gtalk_parseXMLFile(xmlFile);
								
			                               print("get 111friend status:",status,fileshare,display,id);

								index = index + 1;
							}

							offlineFriendCount=Minus(friendCount,onlineFriendCount);
							offlineFriendCount=Minus(offlineFriendCount,subCount);
							offlineFriendCount=Add(offlineFriendCount,tmp_repeatNum);

							index = 0;
							while(1)
							{
								if (index == friendCount)
									break;	

								jid=getXMLText("report","roster","item",index,"jid");
								subscription=getXMLText("report","roster","item",index,"subscription");
								print("jid===========",jid);
								onlineIndex=0;
								while(1)
									{
										if (onlineIndex == onlineFriendCount)
											break;

										status=getXMLText("report","friend",onlineIndex,"status");
										if(status=="5") status="Available";
										if(status=="4") status="busy";
										if(status=="3") status="idle";
										
										fileshare=getXMLText("report","friend",onlineIndex,"fileshare");
										display=getXMLText("report","friend",onlineIndex,"display");
										id=getXMLText("report","friend",onlineIndex,"id");
										image = "../image/gtalker_default.jpg";

										if(jid==display)
											{
											print("jid==display=============",display);
												break;
											}
										

										
					                               print("get 222friend status:",status,fileshare,display,id);

										onlineIndex = onlineIndex + 1;


									}

								if(onlineIndex == onlineFriendCount)
									{
										if(subscription=="none")
											statusArray=pushBackStringArray(statusArray, "Invited");
										else
											statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, jid);
										idArray=pushBackStringArray(idArray, jid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");


										msgjidCount=getXMLElementCount("report","message","jid");
										if(msgjidCount &gt; 0)
											{
												msgjidIndex=0;
												while(1)
												{
												    if(msgjidIndex==msgjidCount)
												    	{
					 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
														break;
												    	}

												    msgjid=getXMLText("report","message","jid",msgjidIndex);

												     if(jid==gtalk_getMsgJidName(msgjid))
												     	
													{
		newmsgArray = pushBackStringArray(newmsgArray, "yes");


														break;
													 
													}


					   							    msgjidIndex=msgjidIndex+1;
												
												}


												
																						}else
	
												newmsgArray = pushBackStringArray(newmsgArray, "no");

										parseResult = gtalk_parseXMLFile(xmlFile);
											}

									
								index=index+1;
								
							}
							
						}

			}
			else
			{
			onlinefriendCount=getXMLElementCount("report","friend");
			subCount=getXMLElementCount("report","subscription","jid");

			msgjidCount=getXMLElementCount("report","message","jid");
			offlineMsgCount=0;
			
			if(msgjidCount &gt; 0)
				{
				msgjidIndex=0;
				while(1)
					{
						 if(msgjidIndex==msgjidCount)
							break;
						msgjid=getXMLText("report","message","jid",msgjidIndex);

						index=0;
						while(1)
							{
							 if(index==onlinefriendCount)
							 	{
							 	offlineMsgCount=Add(offlineMsgCount,1);
								break;
							 	}

							 display=getXMLText("report","friend",index,"display");
							  if(display==gtalk_getMsgJidName(msgjid))
							 	break;			
							 index=Add(index,1);
							}
						


						msgjidIndex=Add(msgjidIndex,1);


					}

				}
			
			
			friendCount=Add(onlinefriendCount,subCount);
			friendCount=Add(friendCount,offlineMsgCount);
			
			print("friendCount :: ",friendCount);
			if (friendCount &gt; 0)
			{

				
				statusArray=null;
				fileshareArray=null;
				displayArray=null;
				idArray=null;	
				imageArray = null;
				statusString=null;
				fileSharingArray=null;
				
				newmsgArray=null;

				subCount=getXMLElementCount("report","subscription","jid");
				index = 0;
				while (1)
				{
					if (index == subCount)
						break;

					display=getXMLText("report","subscription","jid",index);

					status="invite you";

					image = "../image/offline.png";
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray,"no");
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, display);					
					imageArray = pushBackStringArray(imageArray, image);
					statusStringArray=pushBackStringArray(statusStringArray," ");
					fileSharingArray=pushBackStringArray(fileSharingArray,"no");
					
					newmsgArray = pushBackStringArray(newmsgArray, "no");
					
                               print("get invite friend status:",status,fileshare,display);

					index = index + 1;
				}
			

				onlinefriendCount=getXMLElementCount("report","friend");
				index = 0;
				while (1)
				{
					if (index == onlinefriendCount)
						break;



					status=getXMLText("report","friend",index,"status");
					if(status=="5") status="Available";
					if(status=="4") status="busy";
					if(status=="3") status="idle";
					
					fileshare=getXMLText("report","friend",index,"fileshare");
					display=getXMLText("report","friend",index,"display");
					id=getXMLText("report","friend",index,"id");
					image = "../image/gtalker_default.jpg";
					statusString=getXMLText("report","friend",index,"statusString");
	
		
					statusArray=pushBackStringArray(statusArray, status);
					fileshareArray=pushBackStringArray(fileshareArray, fileshare);
					displayArray=pushBackStringArray(displayArray, display);
					idArray=pushBackStringArray(idArray, id);					
					imageArray = pushBackStringArray(imageArray, image);
					
					fileCount=getXMLElementCount("report","file");
					if(fileCount &gt; 0)
						{
						   fileIndex=0;
						   while(1)
						   	{
						   	  if(fileIndex ==fileCount)
						   	  	{
						   	  	fileSharingArray=pushBackStringArray(fileSharingArray,"no");
								break;
							  	}

							  fileid=getXMLText("report","file",fileIndex,"id");

							  if(fileid==id)
							  	{
							  	fileSharingArray=pushBackStringArray(fileSharingArray,"yes");
								break;
							  	}
							  fileIndex=Add(fileIndex,1);


						   	}


						}else
							{
							fileSharingArray=pushBackStringArray(fileSharingArray,"no");
							}
					
					statusStringArray=pushBackStringArray(statusStringArray,statusString);

					msgjidCount=getXMLElementCount("report","message","jid");
					if(msgjidCount &gt; 0)
						{
							msgjidIndex=0;
							while(1)
							{
							    if(msgjidIndex==msgjidCount)
							    	{
 								    	newmsgArray = pushBackStringArray(newmsgArray, "no");
									break;
							    	}

							    msgjid=getXMLText("report","message","jid",msgjidIndex);

							     if(display==gtalk_getMsgJidName(msgjid))
							     	{
									newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									break;
								 }

   							    msgjidIndex=msgjidIndex+1;
							}

							
						}
					else
						newmsgArray = pushBackStringArray(newmsgArray, "no");

					parseResult = gtalk_parseXMLFile(xmlFile);
					
                               print("get friend status:",status,fileshare,display,id);

					index = index + 1;
				}



				msgjidCount=getXMLElementCount("report","message","jid");
				offlineMsgCount=0;
				
				if(msgjidCount &gt; 0)
					{
					msgjidIndex=0;
					while(1)
						{
							 if(msgjidIndex==msgjidCount)
								break;
							 
							msgjid=getXMLText("report","message","jid",msgjidIndex);

							index=0;
							while(1)
								{
								 if(index==onlinefriendCount)
								 	{
								 	offlineMsgCount=Add(offlineMsgCount,1);

										statusArray=pushBackStringArray(statusArray, "Offline");
										fileshareArray=pushBackStringArray(fileshareArray, "no");
										displayArray=pushBackStringArray(displayArray, msgjid);
										idArray=pushBackStringArray(idArray, msgjid);					
										imageArray = pushBackStringArray(imageArray, "../image/offline.png");									

										statusStringArray=pushBackStringArray(statusStringArray," ");
										fileSharingArray=pushBackStringArray(fileSharingArray,"no");
										newmsgArray = pushBackStringArray(newmsgArray, "yes");	
									
									break;
								 	}

								 display=getXMLText("report","friend",index,"display");
								 if(display==gtalk_getMsgJidName(msgjid))
								 	break;			
								 index=Add(index,1);
								}
							


							msgjidIndex=Add(msgjidIndex,1);


						}

					}
				







				setFocusItemIndex(0);
				redrawDisplay();
		 


				null;
				}
				else
				{
				print("!!!!!! No friend found !!!!!!");
				setFocusItemIndex(0);
				null;
				}


			}
					
		}

	}
	setFocusItemIndex(0);
	redrawDisplay();
</script>


<item_template>
<displayTitle>
<script>
friendDisplay=getStringArrayAt(displayArray , -1);
idDisplay=getStringArrayAt(idArray , -1);
</script>
</displayTitle>
<onClick>
path = getStoragePath("tmp") + "gtalk_to_friend.dat";
writeStringToFile(path, friendDisplay);
path = getStoragePath("tmp") + "gtalk_to_friendid.dat";
writeStringToFile(path, idDisplay);


	itemFocusIndex=getFocusItemIndex();
	print("itemFocusIndex==",itemFocusIndex);
	status=getStringArrayAt(statusArray,itemFocusIndex);
	fileshare=getStringArrayAt(fileshareArray,itemFocusIndex);	
	jid=getStringArrayAt(displayArray,itemFocusIndex);
	print("FocusFriend status==",status);

	
	warning="You cannot send files because user is using chat in Gmail or is using another chat program.";
	warning="You cannot send files because user is offline";


	browserListArray = readStringFromFile("/tmp/BrowserCheckList.m3u");
	print("browserListArray=======",browserListArray);

 if(status!="Offline" &amp;&amp; fileshare!="no")
 	{
		rss = "./IMS_Modules/gtalk/scripts/popupDialog.rss";
		confirm = doModalRss(rss, "mediaDisplay", "sendtobuddyDialog", 0);

	   if (confirm == "$[YES]")
	  {
		print("****enter  YES  ***********");
		
	 	browserListArray = readStringFromFile("/tmp/BrowserCheckList.m3u");
		if(browserListArray!=NULL)
			{

				ret=gtalk_sendM3uFiles(idDisplay,browserListArray);

				print("get play input,send m3u files,ret = ",ret);

				postMessage("switch_ap","GBrowserGridViewAP");
			}else	
				{
				warning="You haven't stepped into File Browser,and select files to m3u.";
	
				}
	
			
		}

 	}
      else
      	{
		rss = "./IMS_Modules/gtalk/scripts/popupDialog.rss";
		confirm = doModalRss(rss, "mediaDisplay", "unsupportDialog", 0);

	  }



		null;
 		
</onClick>
</item_template>


<channel>
<title>Gtalk Guide</title>
<link>gtalk_guide.rss</link>


<menuSize>
<script>
menuSize=5;
</script>
</menuSize>
<itemSize>
<script>
friendCount;
</script>
</itemSize>

</channel>
</rss>
